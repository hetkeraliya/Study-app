<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Smooth Page Transitions */
        .page {
            display: none; /* Hide all pages by default */
            animation: fadeIn 0.5s ease-in-out;
        }
        .page.active {
            display: block; /* Show only the active page */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Glassmorphism Nav */
        .island-nav {
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            background-color: rgba(23, 23, 35, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.125);
        }

        /* Modal Animation */
        .modal {
            animation: modalFadeIn 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Micro-interactions */
        .btn-hover {
            transition: all 0.2s ease;
        }
        .btn-hover:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .btn-hover:active {
            transform: scale(0.98);
        }
        .nav-icon:hover {
            color: #3b82f6; /* blue-500 */
        }
        .nav-icon.active {
            color: #3b82f6; /* blue-500 */
            transform: scale(1.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-indigo-950 text-white font-sans overflow-hidden h-screen flex flex-col">

    <!-- 
    ========================================================================
    LOGIN / REGISTER PAGE
    This is the first thing users see.
    ========================================================================
    -->
    <div id="auth-page" class="page active h-full">
        <div class="flex items-center justify-center h-full px-4">
            <div id="auth-container" class="w-full max-w-md p-8 bg-gray-800 rounded-2xl shadow-2xl">
                <!-- Login Form -->
                <div id="login-form">
                    <h2 class="text-3xl font-bold text-center mb-8">Login to Study Hub</h2>
                    <input id="login-email" type="email" placeholder="Email" class="w-full p-3 mb-4 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="login-password" type="password" placeholder="Password" class="w-full p-3 mb-6 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="login-button" class="w-full p-3 bg-blue-600 rounded-lg font-semibold text-lg btn-hover hover:bg-blue-700">Login</button>
                    <p class="text-center text-gray-400 mt-6">
                        No account? <a href="#" id="show-register" class="text-blue-400 hover:underline">Register here</a>
                    </p>
                </div>
                <!-- Register Form -->
                <div id="register-form" class="hidden">
                    <h2 class="text-3xl font-bold text-center mb-8">Create Account</h2>
                    <input id="register-name" type="text" placeholder="Your Name" class="w-full p-3 mb-4 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="register-email" type="email" placeholder="Email" class="w-full p-3 mb-4 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="register-password" type="password" placeholder="Password (min. 6 characters)" class="w-full p-3 mb-6 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="register-button" class="w-full p-3 bg-green-600 rounded-lg font-semibold text-lg btn-hover hover:bg-green-700">Create Account</button>
                    <p class="text-center text-gray-400 mt-6">
                        Already have an account? <a href="#" id="show-login" class="text-blue-400 hover:underline">Login here</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 
    ========================================================================
    MAIN APP (Hidden until logged in)
    ========================================================================
    -->
    <div id="app-container" class="hidden h-full flex flex-col">

        <!-- Header -->
        <header class="flex-shrink-0 flex items-center justify-between p-4">
            <div class="flex items-center">
                <h1 class="text-2xl font-bold">Study Hub</h1>
                <div class="ml-4 bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-semibold flex items-center">
                    <i class="fas fa-coins mr-2"></i>
                    <span id="coin-display">0</span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button class="text-gray-400 hover:text-white text-xl btn-hover">
                    <i class="fas fa-bell"></i>
                </button>
                <button id="account-button" class="text-gray-400 hover:text-white text-xl btn-hover" data-page="account">
                    <i class="fas fa-user-circle"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Area (Scrollable) -->
        <main class="flex-1 overflow-y-auto p-4 mb-24">
            
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page active">
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Pomodoro Timer -->
                    <div class="md:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Pomodoro Timer</h3>
                        <div class="text-6xl font-bold text-center my-8" id="pomodoro-timer">25:00</div>
                        <div class="flex justify-center space-x-4">
                            <button id="pomodoro-start" class="p-3 bg-blue-600 rounded-lg font-semibold btn-hover hover:bg-blue-700"><i class="fas fa-play"></i> Start</button>
                            <button id="pomodoro-reset" class="p-3 bg-gray-600 rounded-lg font-semibold btn-hover hover:bg-gray-700"><i class="fas fa-redo"></i> Reset</button>
                        </div>
                    </div>
                    
                    <!-- Stats & Graphs -->
                    <div class="md:col-span-2 bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Your Week</h3>
                        <canvas id="focus-chart"></canvas>
                    </div>

                    <!-- Lofi Player -->
                    <div class="md:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Lofi Station</h3>
                        <p class="text-gray-400 mb-4">Focus with some beats.</p>
                        <audio id="lofi-player" src="https://stream.lofi.cafe/lofi" controls class="w-full"></audio>
                    </div>

                    <!-- Leaderboard -->
                    <div class="md:col-span-2 bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Leaderboard</h3>
                        <ul id="leaderboard-list" class="space-y-3">
                            <!-- JS will fill this -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Tasks Page -->
            <div id="tasks-page" class="page max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold mb-6">My Tasks</h2>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <div class="flex mb-4">
                        <input id="task-input" type="text" placeholder="Add a new task..." class="flex-grow p-3 bg-gray-700 rounded-l-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="add-task-button" class="p-3 bg-blue-600 rounded-r-lg font-semibold btn-hover hover:bg-blue-700"><i class="fas fa-plus"></i></button>
                    </div>
                    <ul id="task-list" class="space-y-3">
                        <!-- JS will fill this -->
                    </ul>
                </div>
            </div>
            
            <!-- Shop Page -->
            <div id="shop-page" class="page max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold mb-6">Shop</h2>
                <div classs="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-lg hover:shadow-blue-500/30 transition-shadow duration-300">
                        <h3 class="text-2xl font-semibold mb-2">Movie Day</h3>
                        <p class="text-gray-400 mb-4">Redeem for a free movie day.</p>
                        <button onclick="buyItem('item-movie', 100)" class="w-full p-3 bg-green-600 rounded-lg font-semibold btn-hover hover:bg-green-700">
                            Buy (100 <i class="fas fa-coins"></i>)
                        </button>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mt-6 hover:shadow-blue-500/30 transition-shadow duration-300">
                        <h3 class="text-2xl font-semibold mb-2">Premium Study Guide</h3>
                        <p class="text-gray-400 mb-4">Get access to an exclusive study guide.</p>
                        <button onclick="buyItem('item-guide', 500)" class="w-full p-3 bg-green-600 rounded-lg font-semibold btn-hover hover:bg-green-700">
                            Buy (500 <i class="fas fa-coins"></i>)
                        </button>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mt-6 hover:shadow-blue-500/30 transition-shadow duration-300">
                        <h3 class="text-2xl font-semibold mb-2">Exclusive Badge</h3>
                        <p class="text-gray-400 mb-4">Show off a cool badge on your profile.</p>
                        <button onclick="buyItem('item-badge', 1000)" class="w-full p-3 bg-green-600 rounded-lg font-semibold btn-hover hover:bg-green-700">
                            Buy (1000 <i class="fas fa-coins"></i>)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Meet Page -->
            <div id="meet-page" class="page max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold mb-6">Meet & Chat</h2>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg text-center">
                    <h3 class="text-xl font-semibold mb-4">Video Chat</h3>
                    <p class="text-gray-400 mb-6">This feature is coming soon!</p>
                    <button class="p-3 bg-gray-600 rounded-lg font-semibold cursor-not-allowed">Join Room</button>
                </div>
            </div>

            <!-- Account Page -->
            <div id="account-page" class="page max-w-3xl mx-auto">
                <h2 class="text-3xl font-bold mb-6">My Account</h2>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <div class="text-center mb-6">
                        <i class="fas fa-user-circle text-8xl text-gray-500"></i>
                        <h3 id="account-name" class="text-2xl font-semibold mt-4">Loading...</h3>
                        <p id="account-email" class="text-gray-400">Loading...</p>
                        <p id="account-userid" class="text-gray-500 text-xs mt-2">Loading...</p>
                    </div>
                    
                    <button id="admin-button" class="hidden w-full p-3 mb-4 bg-yellow-500 text-black rounded-lg font-semibold btn-hover">
                        <i class="fas fa-shield-alt"></i> Admin Panel
                    </button>
                    
                    <button id="make-admin-button" class="w-full p-3 mb-4 bg-purple-600 rounded-lg font-semibold btn-hover">
                        Make Me Admin (Test)
                    </button>

                    <button id="logout-button" class="w-full p-3 bg-red-600 rounded-lg font-semibold btn-hover hover:bg-red-700">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

        </main>

        <!-- Bottom "Island" Navigation -->
        <nav class="fixed bottom-4 left-1/2 -translate-x-1/2 w-auto max-w-sm mx-auto">
            <div class="flex justify-center items-center space-x-8 p-4 island-nav rounded-full shadow-2xl">
                <button class="nav-icon text-gray-400 text-3xl" data-page="shop">
                    <i class="fas fa-store"></i>
                </button>
                <button class="nav-icon text-gray-400 text-3xl" data-page="tasks">
                    <i class="fas fa-tasks"></i>
                </button>
                <button class="nav-icon active text-3xl" data-page="dashboard">
                    <i class="fas fa-home"></i>
                </button>
                <button class="nav-icon text-gray-400 text-3xl" data-page="meet">
                    <i class="fas fa-video"></i>
                </button>
            </div>
        </nav>
    </div>

    <!-- 
    ========================================================================
    MODAL (Popup for notifications)
    ========================================================================
    -->
    <div id="modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <div id="modal-spinner" class="hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto"></div>
                <p class="text-lg mt-4" id="modal-message-loading">Loading...</p>
            </div>
            <div id="modal-content">
                <div id="modal-icon" class="text-5xl mb-4"></div>
                <p class="text-lg mb-6" id="modal-message"></p>
                <button id="modal-close-button" class="w-full p-3 bg-blue-600 rounded-lg font-semibold btn-hover hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>


    <!-- 
    ========================================================================
    FIREBASE & APP JAVASCRIPT
    ========================================================================
    -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut,
            updateProfile,
            getIdTokenResult
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            onSnapshot, 
            collection,
            query,
            limit,
            updateDoc,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ----------------------------------------------------------------
        // YOUR FIREBASE CONFIG
        // This is your project's "key".
        // ----------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBKtsJ04JKORKMGs-93VuS-2_f9Pm-R_ck",
            authDomain: "study-app-79f4e.firebaseapp.com",
            projectId: "study-app-79f4e",
            storageBucket: "study-app-79f4e.firebasestorage.app",
            messagingSenderId: "787891253761",
            appId: "1:787891253761:web:79b60e1b09a26319480600",
            measurementId: "G-CEF5V167ZJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- App State ---
        let currentUser = null;
        let userData = {
            name: "",
            coins: 0,
            tasks: [],
            focusTime: {}, // { "2024-11-08": 75, "2024-11-09": 50 }
            inventory: []
        };
        let userDocRef = null;
        let leaderboardColRef = null;
        let appDataColRef = null;
        const appId = 'default-app-id'; // Use a consistent ID

        // --- Pomodoro State ---
        let pomodoroInterval = null;
        let pomodoroTime = 25 * 60; // 25 minutes in seconds
        let pomodoroRunning = false;
        
        // --- Chart State ---
        let focusChart = null;

        // ----------------------------------------------------------------
        // UI ELEMENTS
        // ----------------------------------------------------------------
        const authPage = document.getElementById('auth-page');
        const appContainer = document.getElementById('app-container');
        
        // Auth Forms
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showLogin = document.getElementById('show-login');
        const showRegister = document.getElementById('show-register');

        // Auth Buttons
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const logoutButton = document.getElementById('logout-button');

        // App Navigation
        const navButtons = document.querySelectorAll('.nav-icon, #account-button');
        const pages = document.querySelectorAll('.page');

        // Dashboard
        const coinDisplay = document.getElementById('coin-display');
        const pomodoroTimer = document.getElementById('pomodoro-timer');
        const pomodoroStart = document.getElementById('pomodoro-start');
        const pomodoroReset = document.getElementById('pomodoro-reset');
        const leaderboardList = document.getElementById('leaderboard-list');

        // Tasks
        const taskInput = document.getElementById('task-input');
        const addTaskButton = document.getElementById('add-task-button');
        const taskList = document.getElementById('task-list');

        // Account
        const accountName = document.getElementById('account-name');
        const accountEmail = document.getElementById('account-email');
        const accountUserId = document.getElementById('account-userid');
        const adminButton = document.getElementById('admin-button');
        const makeAdminButton = document.getElementById('make-admin-button');

        // Modal
        const modal = document.getElementById('modal');
        const modalSpinner = document.getElementById('modal-spinner');
        const modalContent = document.getElementById('modal-content');
        const modalIcon = document.getElementById('modal-icon');
        const modalMessage = document.getElementById('modal-message');
        const modalMessageLoading = document.getElementById('modal-message-loading');
        const modalCloseButton = document.getElementById('modal-close-button');


        // ----------------------------------------------------------------
        // MODAL FUNCTIONS
        // ----------------------------------------------------------------
        function showModal(message, isLoading = false, type = 'info') {
            modal.classList.remove('hidden');
            if (isLoading) {
                modalMessageLoading.textContent = message;
                modalSpinner.classList.remove('hidden');
                modalContent.classList.add('hidden');
            } else {
                modalMessage.textContent = message;
                modalSpinner.classList.add('hidden');
                modalContent.classList.remove('hidden');
                
                if (type === 'success') {
                    modalIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                } else if (type === 'error') {
                    modalIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                } else {
                    modalIcon.innerHTML = '<i class="fas fa-info-circle text-blue-500"></i>';
                }
            }
        }
        function hideModal() {
            modal.classList.add('hidden');
        }
        modalCloseButton.addEventListener('click', hideModal);


        // ----------------------------------------------------------------
        // AUTHENTICATION
        // ----------------------------------------------------------------
        
        // Listen for auth state changes (Login/Logout)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is logged in
                currentUser = user;
                
                // Set up Firestore references
                const userId = user.uid;
                appDataColRef = doc(db, `/artifacts/${appId}/users/${userId}/appData/data`);
                leaderboardColRef = doc(db, `/artifacts/${appId}/public/data/leaderboard/${userId}`);

                // Load or create user data
                await setupUserData(user.uid, user.displayName, user.email);

                // Update Account Page UI
                accountName.textContent = userData.name || 'Anonymous';
                accountEmail.textContent = user.email;
                accountUserId.textContent = `User ID: ${user.uid}`;

                // Check if user is an admin
                const tokenResult = await getIdTokenResult(user);
                if (tokenResult.claims.admin) {
                    adminButton.classList.remove('hidden');
                }
                
                // Switch to the app
                authPage.classList.remove('active');
                authPage.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
                showPage('dashboard');
                
                // Start listening for data changes
                listenToUserData();
                listenToLeaderboard();

            } else {
                // User is logged out
                currentUser = null;
                authPage.classList.add('active');
                authPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
            }
        });

        // Setup User Data (on first login/register)
        async function setupUserData(uid, name, email) {
            const docSnap = await getDoc(appDataColRef);
            if (!docSnap.exists()) {
                // New user, create their data
                userData = {
                    name: name || "New User",
                    email: email,
                    coins: 0,
                    tasks: [],
                    focusTime: {},
                    inventory: []
                };
                await setDoc(appDataColRef, userData);
                
                // Also create their leaderboard entry
                await setDoc(leaderboardColRef, {
                    name: name || "New User",
                    totalCoins: 0,
                    totalFocus: 0
                });

            } else {
                // Existing user, load their data
                userData = docSnap.data();
            }
        }

        // --- Auth Form Switching ---
        showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });
        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        // --- Register Button ---
        registerButton.addEventListener('click', async () => {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            if (!name || !email || password.length < 6) {
                showModal('Please fill in all fields. Password must be 6+ characters.', false, 'error');
                return;
            }
            
            showModal('Creating account...', true);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Update profile (this adds their name)
                await updateProfile(userCredential.user, { displayName: name });
                // We don't hideModal here, onAuthStateChanged will handle it
            } catch (error) {
                showModal(error.message, false, 'error');
            }
        });

        // --- Login Button ---
        loginButton.addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showModal('Please enter email and password.', false, 'error');
                return;
            }
            
            showModal('Logging in...', true);
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // We don't hideModal here, onAuthStateChanged will handle it
            } catch (error) {
                showModal(error.message, false, 'error');
            }
        });

        // --- Logout Button ---
        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });


        // ----------------------------------------------------------------
        // DATA SYNCING (Real-time)
        // ----------------------------------------------------------------
        
        // Listen for changes to the user's private data
        function listenToUserData() {
            onSnapshot(appDataColRef, (doc) => {
                if (doc.exists()) {
                    userData = doc.data();
                    // Update UI components that depend on this data
                    coinDisplay.textContent = userData.coins;
                    renderTasks();
                    updateChart();
                }
            });
        }

        // Listen for changes to the public leaderboard data
        function listenToLeaderboard() {
            const q = query(collection(db, `/artifacts/${appId}/public/data/leaderboard`), limit(10));
            onSnapshot(q, (snapshot) => {
                let leaders = [];
                snapshot.forEach((doc) => {
                    leaders.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by totalFocus, then totalCoins
                leaders.sort((a, b) => b.totalFocus - a.totalFocus || b.totalCoins - a.totalCoins);

                // Render the leaderboard
                leaderboardList.innerHTML = '';
                leaders.forEach((leader, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-3 bg-gray-700 rounded-lg';
                    li.innerHTML = `
                        <div class="flex items-center">
                            <span class="font-bold text-lg w-6">${index + 1}</span>
                            <span class="ml-4">${leader.name}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-blue-400">${leader.totalFocus} min</div>
                            <div class="text-sm text-gray-400">${leader.totalCoins} <i class="fas fa-coins"></i></div>
                        </div>
                    `;
                    leaderboardList.appendChild(li);
                });
            });
        }

        // --- Save Data (Helper function) ---
        // This function saves the *entire* local userData object to Firebase.
        async function saveUserData() {
            if (!appDataColRef) return;
            try {
                await setDoc(appDataColRef, userData);
            } catch (error) {
                console.error("Error saving user data:", error);
                showModal("Error: Could not save data.", false, 'error');
            }
        }
        
        // --- Update Leaderboard (Helper function) ---
        async function updateLeaderboard(focusToAdd, coinsToAdd) {
            if (!leaderboardColRef) return;
            try {
                const docSnap = await getDoc(leaderboardColRef);
                const data = docSnap.data();
                const newTotalFocus = (data.totalFocus || 0) + focusToAdd;
                const newTotalCoins = (data.totalCoins || 0) + coinsToAdd;
                
                await updateDoc(leaderboardColRef, {
                    totalFocus: newTotalFocus,
                    totalCoins: newTotalCoins,
                    name: userData.name // Keep name in sync
                });
            } catch (error) {
                console.error("Error updating leaderboard:", error);
            }
        }

        // --- Update Coins (Helper function) ---
        async function updateUserCoins(amount) {
            if (!appDataColRef) return;
            
            const newCoins = (userData.coins || 0) + amount;
            userData.coins = newCoins; // Update local state
            coinDisplay.textContent = newCoins;
            
            // Save to DB
            try {
                await updateDoc(appDataColRef, { coins: newCoins });
                // Also update leaderboard total
                await updateLeaderboard(0, amount);
                
                showModal(`+${amount} Coins!`, false, 'success');
                
            } catch (error) {
                console.error("Error updating coins:", error);
                showModal("Error saving coins.", false, 'error');
            }
        }
        

        // ----------------------------------------------------------------
        // PAGE NAVIGATION
        // ----------------------------------------------------------------
        function showPage(pageId) {
            // Hide all pages
            pages.forEach(page => page.classList.remove('active'));
            // Show the target page
            document.getElementById(`${pageId}-page`).classList.add('active');
            
            // Update nav button active state
            navButtons.forEach(btn => {
                if (btn.dataset.page === pageId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                showPage(button.dataset.page);
            });
        });


        // ----------------------------------------------------------------
        // TASKS PAGE
        // ----------------------------------------------------------------
        function renderTasks() {
            taskList.innerHTML = '';
            if (!userData.tasks || userData.tasks.length === 0) {
                taskList.innerHTML = '<p class="text-gray-500 text-center">No tasks yet. Add one!</p>';
                return;
            }
            
            userData.tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = `flex items-center p-3 bg-gray-700 rounded-lg ${task.completed ? 'opacity-50' : ''}`;
                li.innerHTML = `
                    <button class="task-toggle text-xl mr-4" data-index="${index}">
                        ${task.completed ? '<i class="fas fa-check-square text-green-500"></i>' : '<i class="far fa-square text-gray-400"></i>'}
                    </button>
                    <span class="flex-grow ${task.completed ? 'line-through' : ''}">${task.text}</span>
                    <button class="task-delete text-red-500 hover:text-red-400 ml-4" data-index="${index}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                taskList.appendChild(li);
            });

            // Add event listeners to new buttons
            document.querySelectorAll('.task-toggle').forEach(btn => {
                btn.addEventListener('click', () => toggleTask(btn.dataset.index));
            });
            document.querySelectorAll('.task-delete').forEach(btn => {
                btn.addEventListener('click', () => deleteTask(btn.dataset.index));
            });
        }

        async function handleAddTask() {
            const text = taskInput.value.trim();
            if (text) {
                const newTask = { text: text, completed: false };
                // Update local state first for speed
                userData.tasks.push(newTask);
                renderTasks();
                taskInput.value = '';
                
                // Save to DB
                await updateDoc(appDataColRef, {
                    tasks: arrayUnion(newTask)
                });
            }
        }

        async function toggleTask(index) {
            const task = userData.tasks[index];
            task.completed = !task.completed;
            
            // If just completed, give coins!
            if (task.completed) {
                updateUserCoins(10); // +10 coins for completing a task
            }

            // Save to DB
            await saveUserData(); // saveUserData is smart, it will re-render
        }

        async function deleteTask(index) {
            const taskToDelete = userData.tasks[index];
            // Remove from local state
            userData.tasks.splice(index, 1);
            
            // Save to DB
            await updateDoc(appDataColRef, {
                tasks: arrayRemove(taskToDelete)
            });
        }
        
        addTaskButton.addEventListener('click', handleAddTask);
        taskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAddTask();
        });


        // ----------------------------------------------------------------
        // DASHBOARD - POMODORO
        // ----------------------------------------------------------------
        function updatePomodoroTimer() {
            const minutes = Math.floor(pomodoroTime / 60);
            const seconds = pomodoroTime % 60;
            pomodoroTimer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function stopPomodoro(completed = false) {
            clearInterval(pomodoroInterval);
            pomodoroRunning = false;
            pomodoroStart.innerHTML = '<i class="fas fa-play"></i> Start';
            
            if (completed) {
                showModal("Session complete! +25 Coins!", false, 'success');
                updateUserCoins(25);
                addFocusTime(25);
            }
        }

        pomodoroStart.addEventListener('click', () => {
            if (pomodoroRunning) {
                // Pause
                clearInterval(pomodoroInterval);
                pomodoroRunning = false;
                pomodoroStart.innerHTML = '<i class="fas fa-play"></i> Resume';
            } else {
                // Start/Resume
                pomodoroRunning = true;
                pomodoroStart.innerHTML = '<i class="fas fa-pause"></i> Pause';
                pomodoroInterval = setInterval(() => {
                    pomodoroTime--;
                    updatePomodoroTimer();
                    if (pomodoroTime <= 0) {
                        stopPomodoro(true);
                        pomodoroTime = 25 * 60;
                        updatePomodoroTimer();
                    }
                }, 1000);
            }
        });

        pomodoroReset.addEventListener('click', () => {
            stopPomodoro(false);
            pomodoroTime = 25 * 60;
            updatePomodoroTimer();
        });


        // ----------------------------------------------------------------
        // DASHBOARD - GRAPHS
        // ----------------------------------------------------------------
        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        async function addFocusTime(minutes) {
            const today = getTodayString();
            const currentFocus = userData.focusTime[today] || 0;
            const newFocus = currentFocus + minutes;
            
            // Use dot notation for nested field update
            const fieldName = `focusTime.${today}`;
            try {
                await updateDoc(appDataColRef, {
                    [fieldName]: newFocus
                });
                // Also update leaderboard
                await updateLeaderboard(minutes, 0);
                
            } catch (error) {
                console.error("Error adding focus time:", error);
            }
            // onSnapshot will handle updating the chart
        }
        
        function updateChart() {
            if (!userData.focusTime) return;
            
            const labels = [];
            const data = [];
            
            // Get last 7 days
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dayString = d.toISOString().split('T')[0];
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                
                labels.push(dayName);
                data.push(userData.focusTime[dayString] || 0);
            }
            
            const ctx = document.getElementById('focus-chart').getContext('2d');
            
            if (focusChart) {
                focusChart.destroy();
            }
            
            focusChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Focus Minutes',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    }
                }
            });
        }


        // ----------------------------------------------------------------
        // SHOP & BACKEND FUNCTIONS
        // ----------------------------------------------------------------
        
        // This is a *GLOBAL* function so the HTML `onclick` can find it
        window.buyItem = async function(itemId, itemPrice) {
            showModal('Processing purchase...', true);
            
            try {
                // 1. Send the "buy request" to our secure backend function
                const response = await fetch('/api/buy-item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.uid,
                        itemId: itemId,
                        itemPrice: itemPrice
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // If response is not 2xx, it's an error
                    throw new Error(data.error || 'Unknown server error');
                }

                // 2. Success!
                // onSnapshot will automatically update our coins,
                // but we show a success message.
                showModal(data.message, false, 'success');

            } catch (error) {
                console.error("Purchase failed:", error.message);
                showModal(`Purchase failed: ${error.message}`, false, 'error');
            }
        }
        
        // --- Make Admin Button (Test) ---
        makeAdminButton.addEventListener('click', async () => {
            showModal('Requesting admin status...', true);
            try {
                const response = await fetch('/api/make-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.uid
                    })
                });
                
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Unknown server error');
                }
                
                // Force refresh of the token to get new admin claim
                await currentUser.getIdToken(true); 
                
                showModal(data.message, false, 'success');
                adminButton.classList.remove('hidden');

            } catch (error) {
                console.error("Admin request failed:", error.message);
                showModal(`Failed: ${error.message}`, false, 'error');
            }
        });
        
    </script>
</body>
</html>ke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M4 8h8a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4a2 2 0 012-2z"></path></svg>
                </button>
            </div>
        </nav>
    </div>

    <!-- 
      AUTH CONTAINER
      Holds the Login and Register pages.
    -->
    <div id="authContainer" class="hidden"> <!-- Hidden until app loads -->
        
        <!-- Login Page -->
        <div id="loginPage" class="page active min-h-screen flex items-center justify-center bg-gray-100">
            <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">Login</h2>
                <form id="loginForm" class="space-y-6">
                    <input id="loginEmail" type="email" placeholder="Email" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="loginPassword" type="password" placeholder="Password" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Login</button>
                </form>
                <p class="text-center text-gray-600 mt-6">
                    Don't have an account? <a href="#" id="showRegister" class="text-blue-600 font-medium hover:underline">Register</a>
                </p>
            </div>
        </div>

        <!-- Register Page -->
        <div id="registerPage" class="page min-h-screen flex items-center justify-center bg-gray-100">
            <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">Register</h2>
                <form id="registerForm" class="space-y-6">
                    <input id="registerName" type="text" placeholder="Full Name" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="registerEmail" type="email" placeholder="Email" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="registerPassword" type="password" placeholder="Password (min. 6 characters)" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Create Account</button>
                </form>
                <p class="text-center text-gray-600 mt-6">
                    Already have an account? <a href="#" id="showLogin" class="text-blue-600 font-medium hover:underline">Login</a>
                </p>
            </div>
        </div>
    </div>

    <!-- 
      GLOBAL LOADING SPINNER
      Shown while Firebase is initializing.
    -->
    <div id="loadingSpinner" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="w-16 h-16 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div>
    </div>

    <!-- 
      NOTIFICATION MODAL (Global)
      Used to show errors and messages.
    -->
    <div id="notificationModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 opacity-0 -translate-y-10 pointer-events-none">
        <div class="max-w-sm w-full bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Notification</h3>
            <p id="notificationMessage" class="text-gray-600 mb-4">This is a message.</p>
            <button id="notificationClose" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">OK</button>
        </div>
    </div>


    <!-- 
      =======================================================
      JAVASCRIPT & FIREBASE
      =======================================================
    -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            onSnapshot,
            collection,
            query
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ======================================================
        // START: Firebase Configuration
        // This is YOUR project config.
        // ======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBKtsJ04JKORKMGs-93VuS-2_f9Pm-R_ck",
            authDomain: "study-app-79f4e.firebaseapp.com",
            projectId: "study-app-79f4e",
            storageBucket: "study-app-79f4e.firebasestorage.app",
            messagingSenderId: "787891253761",
            appId: "1:787891253761:web:79b60e1b09a26319480600",
            measurementId: "G-CEF5V167ZJ"
        };
        // ======================================================
        // END: Firebase Configuration
        // ======================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // This `appId` is provided by the environment you run in.
        // It's used to separate data in Firestore.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Global variables for user data and state
        let currentUserId = null;
        let userData = {
            name: "User",
            coins: 0,
            focusTime: 0, // in minutes
            tasks: []
        };

        // Pomodoro Timer state
        let timerInterval = null;
        let timerSeconds = 25 * 60; // 25 minutes
        let isTimerRunning = false;

        // ======================================================
        // DOM Element References
        // ======================================================
        const appContainer = document.getElementById("appContainer");
        const authContainer = document.getElementById("authContainer");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const allPages = document.querySelectorAll(".page");

        // Auth forms
        const loginPage = document.getElementById("loginPage");
        const registerPage = document.getElementById("registerPage");
        const loginForm = document.getElementById("loginForm");
        const registerForm = document.getElementById("registerForm");
        const showRegister = document.getElementById("showRegister");
        const showLogin = document.getElementById("showLogin");

        // App content
        const userNameDisplay = document.getElementById("userNameDisplay");
        const userCoinsDisplay = document.getElementById("userCoinsDisplay");
        const tasksLeftDisplay = document.getElementById("tasksLeftDisplay");
        const focusTimeDisplay = document.getElementById("focusTimeDisplay");
        const logoutButton = document.getElementById("logoutButton");
        const accountName = document.getElementById("accountName");
        const accountEmail = document.getElementById("accountEmail");

        // Navigation
        const islandMenu = document.getElementById("islandMenu");
        const navButtons = document.querySelectorAll(".nav-button");
        const accountButton = document.getElementById("accountButton");
        const notificationButton = document.getElementById("notificationButton");
        const adminButton = document.getElementById("adminButton");

        // Tasks
        const addTaskForm = document.getElementById("addTaskForm");
        const taskInput = document.getElementById("taskInput");
        const taskList = document.getElementById("taskList");

        // Pomodoro
        const pomodoroDisplay = document.getElementById("pomodoroDisplay");
        const startTimerButton = document.getElementById("startTimerButton");
        const resetTimerButton = document.getElementById("resetTimerButton");

        // Leaderboard
        const leaderboardList = document.getElementById("leaderboardList");

        // Modal
        const notificationModal = document.getElementById("notificationModal");
        const notificationMessage = document.getElementById("notificationMessage");
        const notificationClose = document.getElementById("notificationClose");

        // ======================================================
        // Utility Functions
        // ======================================================

        // Show a custom notification message
        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationModal.classList.remove("opacity-0", "-translate-y-10", "pointer-events-none");
            notificationModal.classList.add("opacity-100", "translate-y-0");
        }

        // Close the notification message
        notificationClose.addEventListener("click", () => {
            notificationModal.classList.add("opacity-0", "-translate-y-10", "pointer-events-none");
            notificationModal.classList.remove("opacity-100", "translate-y-0");
        });

        // Navigate between pages
        function navigateTo(pageId) {
            allPages.forEach(page => {
                page.classList.remove("active");
            });
            document.getElementById(pageId).classList.add("active");

            // Update Island Menu active state
            navButtons.forEach(button => {
                if (button.dataset.page === pageId) {
                    button.classList.add("bg-blue-600");
                } else {
                    button.classList.remove("bg-blue-600");
                }
            });
            window.scrollTo(0, 0); // Scroll to top on page change
        }

        // ======================================================
        // Authentication Logic
        // ======================================================

        // Main auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                
                // Set display info immediately
                accountName.textContent = user.displayName || "User";
                accountEmail.textContent = user.email;

                // Load user data from Firestore
                await loadUserData(user.uid);

                // Check for admin claims (this is an advanced feature)
                const idTokenResult = await user.getIdTokenResult();
                if (idTokenResult.claims.admin) {
                    adminButton.classList.remove("hidden");
                }
                
                // Show app, hide auth
                appContainer.classList.remove("hidden");
                authContainer.classList.add("hidden");
                
                // Set up real-time data listeners
                setupListeners(user.uid);
                
            } else {
                // User is signed out
                currentUserId = null;
                
                // Show auth, hide app
                authContainer.classList.remove("hidden");
                appContainer.classList.add("hidden");
                navigateTo("loginPage");
            }
            // Hide global loading spinner
            loadingSpinner.classList.add("hidden");
        });

        // Registration
        registerForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.getElementById("registerName").value;
            const email = document.getElementById("registerEmail").value;
            const password = document.getElementById("registerPassword").value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Update Firebase Auth profile
                await updateProfile(user, { displayName: name });
                
                // Create initial user data in Firestore
                const initialData = {
                    name: name,
                    email: email,
                    coins: 0,
                    focusTime: 0,
                    tasks: []
                };
                // Create private user doc
                await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/appData`, "data"), initialData);
                
                // Create public leaderboard doc
                await setDoc(doc(db, `artifacts/${appId}/public/data/leaderboard`, user.uid), {
                    name: name,
                    coins: 0
                });

                // `onAuthStateChanged` will handle the rest
                
            } catch (error) {
                showNotification(`Registration failed: ${error.message}`);
                console.error("Registration error:", error);
            }
        });

        // Login
        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // `onAuthStateChanged` will handle navigation
            } catch (error) {
                showNotification(`Login failed: ${error.message}`);
                console.error("Login error:", error);
            }
        });

        // Logout
        logoutButton.addEventListener("click", async () => {
            try {
                await signOut(auth);
                // `onAuthStateChanged` will handle navigation
            } catch (error) {
                showNotification(`Logout failed: ${error.message}`);
            }
        });

        // Auth page navigation
        showRegister.addEventListener("click", (e) => {
            e.preventDefault();
            navigateTo("registerPage");
        });
        showLogin.addEventListener("click", (e) => {
            e.preventDefault();
            navigateTo("loginPage");
        });

        // ======================================================
        // App Navigation Logic
        // ======================================================

        // Island Menu navigation
        islandMenu.addEventListener("click", (e) => {
            const button = e.target.closest(".nav-button");
            if (button) {
                navigateTo(button.dataset.page);
            }
        });
        
        // Header navigation
        accountButton.addEventListener("click", () => navigateTo("pageAccount"));
        notificationButton.addEventListener("click", () => navigateTo("pageNotifications"));
        adminButton.addEventListener("click", () => navigateTo("pageAdmin"));

        // ======================================================
        // Firestore Data Management
        // ======================================================
        
        // Get user data doc reference
        function getUserDocRef(userId) {
            return doc(db, `artifacts/${appId}/users/${userId}/appData`, "data");
        }
        
        // Get leaderboard doc reference
        function getLeaderboardDocRef(userId) {
            return doc(db, `artifacts/${appId}/public/data/leaderboard`, userId);
        }

        // Load user data once on login
        async function loadUserData(userId) {
            const docRef = getUserDocRef(userId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                userData = docSnap.data();
                updateUI();
            } else {
                console.warn("No user data found, but this should have been created on register.");
                // This state is unlikely if registration is correct
            }
        }
        
        // Save the entire `userData` object to Firestore
        async function saveUserData() {
            if (!currentUserId) return;
            try {
                await setDoc(getUserDocRef(currentUserId), userData);
            } catch (error) {
                console.error("Error saving user data:", error);
                showNotification("Error saving data. Please check console.");
            }
        }
        
        // Update public leaderboard
        async function updateLeaderboardData(name, coins) {
            if (!currentUserId) return;
             try {
                await setDoc(getLeaderboardDocRef(currentUserId), { name, coins });
            } catch (error) {
                console.error("Error saving leaderboard data:", error);
            }
        }
        
        // Set up real-time listeners
        function setupListeners(userId) {
            // 1. Listen for changes to this user's private data
            const userDocRef = getUserDocRef(userId);
            onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    userData = doc.data();
                    updateUI();
                }
            }, (error) => {
                console.error("Error with user data snapshot:", error);
            });
            
            // 2. Listen for changes to the public leaderboard
            const leaderboardCollectionRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);
            const q = query(leaderboardCollectionRef); // You can add orderBy and limit here
            
            onSnapshot(q, (snapshot) => {
                let leaderboard = [];
                snapshot.forEach((doc) => {
                    leaderboard.push(doc.data());
                });
                
                // Sort by coins (descending) in JavaScript
                leaderboard.sort((a, b) => b.coins - a.coins);
                
                // Render leaderboard
                leaderboardList.innerHTML = ""; // Clear list
                leaderboard.slice(0, 10).forEach((entry, index) => { // Show top 10
                    const li = document.createElement("li");
                    li.className = "flex items-center justify-between p-3 bg-gray-50 rounded-lg";
                    li.innerHTML = `
                        <span class="font-medium text-gray-700">${index + 1}. ${entry.name}</span>
                        <span class="font-bold text-blue-600">${entry.coins} Coins</span>
                    `;
                    leaderboardList.appendChild(li);
                });
                
            }, (error) => {
                 console.error("Error with leaderboard snapshot:", error);
            });
        }
        
        // ======================================================
        // UI Update Functions
        // ======================================================
        
        // Update all UI elements from the `userData` object
        function updateUI() {
            // Dashboard
            userNameDisplay.textContent = userData.name || "User";
            userCoinsDisplay.textContent = userData.coins || 0;
            tasksLeftDisplay.textContent = userData.tasks.filter(t => !t.completed).length;
            focusTimeDisplay.textContent = `${userData.focusTime || 0}m`;
            
            // Account Page
            accountName.textContent = userData.name || "User";
            
            // Task Page
            renderTasks();
        }

        // ======================================================
        // Task Management
        // ======================================================
        
        function renderTasks() {
            taskList.innerHTML = ""; // Clear existing list
            if (userData.tasks.length === 0) {
                taskList.innerHTML = `<p class="text-gray-500 text-center">No tasks yet. Add one!</p>`;
                return;
            }
            
            userData.tasks.forEach(task => {
                const li = document.createElement("li");
                li.className = `task-item flex items-center justify-between p-4 bg-gray-50 rounded-lg ${task.completed ? 'completed' : ''}`;
                li.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" data-id="${task.id}" class="task-checkbox h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${task.completed ? 'checked' : ''}>
                        <label for="task-${task.id}" class="text-gray-800">${task.text}</label>
                    </div>
                    <button data-id="${task.id}" class="delete-task-btn p-1 text-gray-400 hover:text-red-500 rounded-full">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                taskList.appendChild(li);
            });
        }
        
        // Add Task
        addTaskForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const text = taskInput.value.trim();
            if (text) {
                const newTask = {
                    id: Date.now().toString(),
                    text: text,
                    completed: false
                };
                userData.tasks.push(newTask);
                taskInput.value = "";
                await saveUserData(); // This will trigger onSnapshot to re-render
            }
        });
        
        // Toggle or Delete Task
        taskList.addEventListener("click", async (e) => {
            const target = e.target;
            
            // Toggle complete
            if (target.classList.contains("task-checkbox")) {
                const taskId = target.dataset.id;
                const task = userData.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = target.checked;
                    
                    // Add coins for completing a task
                    if (task.completed) {
                        userData.coins += 10; // Give 10 coins
                        await updateLeaderboardData(userData.name, userData.coins);
                    }
                    
                    await saveUserData(); // This will trigger onSnapshot
                }
            }
            
            // Delete task
            if (target.closest(".delete-task-btn")) {
                const taskId = target.closest(".delete-task-btn").dataset.id;
                userData.tasks = userData.tasks.filter(t => t.id !== taskId);
                await saveUserData(); // This will trigger onSnapshot
            }
        });

        // ======================================================
        // Pomodoro Timer Logic
        // ======================================================
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            pomodoroDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function startTimer() {
            if (isTimerRunning) return;
            isTimerRunning = true;
            startTimerButton.textContent = "Pause";
            
            timerInterval = setInterval(async () => {
                timerSeconds--;
                if (timerSeconds < 0) {
                    // Timer finished
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    startTimerButton.textContent = "Start";
                    timerSeconds = 25 * 60; // Reset
                    
                    // Add coins and focus time
                    userData.coins += 50; // 50 coins for a full session
                    userData.focusTime += 25; // 25 minutes
                    
                    // Save and update leaderboard
                    await updateLeaderboardData(userData.name, userData.coins);
                    await saveUserData();
                    
                    showNotification("Focus session complete! You earned 50 coins.");
                }
                updateTimerDisplay();
            }, 1000);
        }
        
        function pauseTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            startTimerButton.textContent = "Start";
        }
        
        function resetTimer() {
            pauseTimer();
            timerSeconds = 25 * 60;
            updateTimerDisplay();
        }
        
        startTimerButton.addEventListener("click", () => {
            if (isTimerRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        });
        
        resetTimerButton.addEventListener("click", resetTimer);
        
        // Initialize timer display
        updateTimerDisplay();

    </script>
</body>
</html>


